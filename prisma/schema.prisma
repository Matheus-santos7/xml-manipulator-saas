generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model CstMapping {
  id         String   @id @default(cuid())
  scenarioId String
  cfop       String
  icms       String?
  ipi        String?
  pis        String?
  cofins     String?
  Scenario   Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
}

model Profile {
  id              String            @id @default(cuid())
  workspaceId     String
  name            String
  cnpj            String            @unique
  razaoSocial     String?
  endereco        Json?
  Workspace       Workspace         @relation(fields: [workspaceId], references: [id])
  Scenario        Scenario[]
  WorkspaceMember WorkspaceMember[]
}

model Scenario {
  id                        String                @id @default(cuid())
  profileId                 String
  name                      String
  active                    Boolean               @default(true)
  editar_emitente           Boolean               @default(false)
  editar_produtos           Boolean               @default(false)
  editar_impostos           Boolean               @default(false)
  editar_data               Boolean               @default(false)
  editar_refNFe             Boolean               @default(false)
  editar_cst                Boolean               @default(false)
  editar_destinatario_pj    Boolean               @default(false)
  editar_destinatario_pf    Boolean               @default(false)
  zerar_ipi_remessa_retorno Boolean               @default(false)
  zerar_ipi_venda           Boolean               @default(false)
  reforma_tributaria        Boolean               @default(false)
  alterar_serie             Boolean               @default(false)
  alterar_cUF               Boolean               @default(false)
  aplicar_reducao_aliq      Boolean               @default(false)
  nova_data                 String?
  nova_serie                String?
  novo_cUF                  String?
  CstMapping                CstMapping[]
  Profile                   Profile               @relation(fields: [profileId], references: [id])
  ScenarioDestinatario      ScenarioDestinatario?
  ScenarioEmitente          ScenarioEmitente?
  ScenarioImposto           ScenarioImposto?
  ScenarioProduto           ScenarioProduto[]
  TaxReformRule             TaxReformRule[]

  @@unique([profileId, name])
}

model ScenarioDestinatario {
  id         String   @id @default(cuid())
  scenarioId String   @unique
  cnpj       String?
  cpf        String?
  xNome      String?
  IE         String?
  xLgr       String?
  nro        String?
  xBairro    String?
  xMun       String?
  UF         String?
  CEP        String?
  fone       String?
  Scenario   Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
}

model ScenarioEmitente {
  id         String   @id @default(cuid())
  scenarioId String   @unique
  cnpj       String?
  xNome      String?
  xLgr       String?
  nro        String?
  xCpl       String?
  xBairro    String?
  xMun       String?
  UF         String?
  fone       String?
  IE         String?
  CEP        String?
  Scenario   Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
}

model ScenarioImposto {
  id          String   @id @default(cuid())
  scenarioId  String   @unique
  pFCP        String?
  pICMS       String?
  pICMSUFDest String?
  pICMSInter  String?
  pPIS        String?
  pCOFINS     String?
  pIPI        String?
  Scenario    Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
}

model ScenarioProduto {
  id           String   @id @default(cuid())
  scenarioId   String
  xProd        String?
  cEAN         String?
  cProd        String?
  NCM          String?
  isPrincipal  Boolean  @default(false) // Produto usado em Venda/Retorno/Devolução
  ordem        Int      @default(0) // Ordem de rotação para Remessa
  Scenario     Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@unique([scenarioId, ordem])
  @@index([scenarioId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TaxReformRule {
  id           String   @id @default(cuid())
  scenarioId   String
  pIBSUF       String?
  pIBSMun      String?
  pCBS         String?
  vDevTrib     String?
  cClassTrib   String?
  CST          String?
  gIBSUF_gRed  Json?
  gIBSMun_gRed Json?
  gCBS_gRed    Json?
  Scenario     Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
}

model User {
  id              String            @id @default(cuid())
  name            String?
  email           String?           @unique
  password        String?           // Hash da senha
  role            String            @default("user") // "user" ou "admin" (System Admin)
  emailVerified   DateTime?
  image           String?
  Account         Account[]
  Session         Session[]
  WorkspaceMember WorkspaceMember[]
}

model Workspace {
  id              String            @id @default(cuid())
  name            String
  slug            String            @unique
  Profile         Profile[]
  WorkspaceMember WorkspaceMember[]
}

model WorkspaceMember {
  id          String    @id @default(cuid())
  workspaceId String
  userId      String
  role        String    @default("member") // "admin" ou "member"
  profileId   String? // Profile associado (apenas para members)
  Profile     Profile?  @relation(fields: [profileId], references: [id])
  User        User      @relation(fields: [userId], references: [id])
  Workspace   Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([workspaceId, userId])
}
